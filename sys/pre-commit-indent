#!/bin/sh
#
# A hook script to verify what is about to be committed follows the coding
# style. Called by "git commit" with no arguments. The hook should exit with
# non-zero status after issuing an appropriate message if it wants to stop the
# commit.
#
# To enable this hook, move it to ".git/hooks/pre-commit".

tmpfile=$(mktemp)
unstaged_diff=$(mktemp)
git diff > ${unstaged_diff}
git checkout -- .
git diff --cached | ./sys/clang-format-diff.py -p1 > ${tmpfile}

restore_exit() {
    git apply < ${unstaged_diff}
    rm ${tmpfile}
    rm ${unstaged_diff}
    exit $1
}

sz=$(wc -c "${tmpfile}" | cut -d" " -f1)
if [ "${sz}" != "0" ] ; then
	echo "Please follow the coding style!"
	echo "Run \`git diff --cached | ./sys/clang-format-diff.py -p1 -i\` to apply the changes listed below and remember to add them to git."
	echo
	cat ${tmpfile}
	restore_exit 1
fi

restore_exit 0
